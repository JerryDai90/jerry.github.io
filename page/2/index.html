<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-一次数据库连接泄露查找" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/24/一次数据库连接泄露查找/" class="article-date">
  <time datetime="2018-09-24T02:00:02.000Z" itemprop="datePublished">2018-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一次数据库连接泄露查找"><a href="#一次数据库连接泄露查找" class="headerlink" title="一次数据库连接泄露查找"></a>一次数据库连接泄露查找</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>有一老项目，在最近出现了耗尽连接数报错。基本半天就会爆掉了。（还部署了双机，更加加快了耗尽连接数的速度）。把代码下载下来的时候吃了一惊，这项目竟然没用数据库连接池。直接使用了这货 <code>org.springframework.jdbc.datasource.DriverManagerDataSource</code>。这货是没有连接池概念的，来一个就创建一个。</p>
<p><img src="http://img.lsof.fun/2018-09-24-15377557097437.jpg" alt="-c200"></p>
<p>那为什么还会连接数耗尽呢？经过调试，发现刷新三观的获取连接的方式。</p>
<blockquote>
<p>代码我就不上了，简单说一下。这个函数的目的是拿到数据库原生连接对象。首先先获取配置好的 DataSource，通过 DataSource 来获取用户名、密码、驱动 <del>_</del>，然后在通用这些 create 一个 Connection。这 TM 是临时工做的吧。</p>
</blockquote>
<p>另外有是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Session session = <span class="keyword">super</span>.getSession();</span><br><span class="line"><span class="comment">//后面没有关闭</span></span><br></pre></td></tr></table></figure>

<p>还有这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Connection connection = <span class="keyword">super</span>.getSession().connection();</span><br><span class="line"><span class="comment">//也没有关闭</span></span><br></pre></td></tr></table></figure>

<p>这样的 <code>Session</code> 获取方式 <code>Hibernate</code> 是不会进行管理的了。也就是说要手动关闭。需要改动的地方太多了（而且修改后需要大量的测试，得不偿失）。需要想一个办法来解决这个问题。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>经过研究，决定从 <code>DataSource</code> 对象下手。前提条件需要可以判断这个连接空闲的时间。使用 mysql 命令可以查看到当前线程数。<br><img src="http://img.lsof.fun/2018-09-24-15377673023807.jpg" alt="-c500"><br>查看 JDBC 的规范，并没有连接最后执行时间的方法。<br><img src="http://img.lsof.fun/2018-09-24-95_047bc205625b0b30-1ec21c4782d02bf2-dcadbe84ab9fad4514af544849194203.jpg" alt="-c"></p>
<p>最后从 Mysql 的驱动实现下手。 <code>com.mysql.jdbc.Connection</code> 里面有个方法叫 <code>getIdleFor</code>，实现类在 <code>com.mysql.jdbc.ConnectionImpl</code>。这个方法可以知道当前连接最后执行完成 sql 语句后的等待时间。</p>
<p>上代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无连接池功能，仅仅是因为代码中有巨多不规范代码导致开启了数据库链接没有关闭导致连接数耗尽 bug 修复.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jerry</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018 -09-24 18:07:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSource4FixedConnLeak</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">jdbc</span>.<span class="title">datasource</span>.<span class="title">DriverManagerDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Log LOG = LogFactory.getLog(DataSource4FixedConnLeak.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> List&lt;Connection&gt; cacheConn = <span class="keyword">new</span> ArrayList&lt;Connection&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line"></span><br><span class="line">        Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line"></span><br><span class="line">        TimerTask task = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (cacheConn) &#123;</span><br><span class="line">                        Iterator&lt;Connection&gt; iterator = cacheConn.iterator();</span><br><span class="line">                        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                            Connection next = iterator.next();</span><br><span class="line">                            <span class="keyword">if</span> (next.isClosed()) &#123;</span><br><span class="line">                                iterator.remove();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                com.mysql.jdbc.Connection connection = (com.mysql.jdbc.Connection) next;</span><br><span class="line">                                <span class="comment">//空闲100毫秒就关闭</span></span><br><span class="line">                                <span class="keyword">if</span> (connection.getIdleFor() &gt;= <span class="number">500l</span>) &#123;</span><br><span class="line"><span class="comment">//                                    LOG.info("isAlive close");</span></span><br><span class="line">                                    connection.close();</span><br><span class="line">                                    iterator.remove();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        timer.schedule(task, <span class="number">500L</span>, <span class="number">1000</span> * <span class="number">2l</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addConnection</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cacheConn) &#123;</span><br><span class="line">            cacheConn.add(connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Connection connection = <span class="keyword">super</span>.getConnection();</span><br><span class="line">        addConnection(connection);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><p>经过 <code>Hibernate</code> 调用的创建的 <code>Connection</code> 都会进行关闭。（脱离管理的 Session 不在范围内）以下是 <code>org.springframework.orm.hibernate3.HibernateTemplate</code> 的执行查询代码片段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Execute the action specified by the given action object within a Session.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action callback object that specifies the Hibernate action</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> enforceNewSession whether to enforce a new Session for this template</span></span><br><span class="line"><span class="comment"> * even if there is a pre-bound transactional Session</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> enforceNativeSession whether to enforce exposure of the native</span></span><br><span class="line"><span class="comment"> * Hibernate Session to callback code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a result object returned by the action, or &lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> org.springframework.dao.DataAccessException in case of Hibernate errors</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doExecute</span><span class="params">(HibernateCallback&lt;T&gt; action, <span class="keyword">boolean</span> enforceNewSession, <span class="keyword">boolean</span> enforceNativeSession)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">	Assert.notNull(action, <span class="string">"Callback object must not be null"</span>);</span><br><span class="line"></span><br><span class="line">	Session session = (enforceNewSession ?</span><br><span class="line">			SessionFactoryUtils.getNewSession(getSessionFactory(), getEntityInterceptor()) : getSession());</span><br><span class="line">	<span class="keyword">boolean</span> existingTransaction = (!enforceNewSession &amp;&amp;</span><br><span class="line">			(!isAllowCreate() || SessionFactoryUtils.isSessionTransactional(session, getSessionFactory())));</span><br><span class="line">	<span class="keyword">if</span> (existingTransaction) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Found thread-bound Session for HibernateTemplate"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FlushMode previousFlushMode = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		previousFlushMode = applyFlushMode(session, existingTransaction);</span><br><span class="line">		enableFilters(session);</span><br><span class="line">		Session sessionToExpose =</span><br><span class="line">				(enforceNativeSession || isExposeNativeSession() ? session : createSessionProxy(session));</span><br><span class="line">		T result = action.doInHibernate(sessionToExpose);</span><br><span class="line">		flushIfNecessary(session, existingTransaction);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (HibernateException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> convertHibernateAccessException(ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> convertJdbcAccessException(ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">		<span class="comment">// Callback code threw application exception...</span></span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (existingTransaction) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Not closing pre-bound Hibernate Session after HibernateTemplate"</span>);</span><br><span class="line">			disableFilters(session);</span><br><span class="line">			<span class="keyword">if</span> (previousFlushMode != <span class="keyword">null</span>) &#123;</span><br><span class="line">				session.setFlushMode(previousFlushMode);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Never use deferred close for an explicitly new Session.</span></span><br><span class="line">			<span class="keyword">if</span> (isAlwaysUseNewSession()) &#123;</span><br><span class="line">				SessionFactoryUtils.closeSession(session);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//close Connection</span></span><br><span class="line">				SessionFactoryUtils.closeSessionOrRegisterDeferredClose(session, getSessionFactory());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关闭方法运行堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">at org.hibernate.jdbc.ConnectionManager.closeConnection(ConnectionManager.java:474)</span><br><span class="line">at org.hibernate.jdbc.ConnectionManager.cleanup(ConnectionManager.java:408)</span><br><span class="line">at org.hibernate.jdbc.ConnectionManager.close(ConnectionManager.java:347)</span><br><span class="line">at org.hibernate.impl.SessionImpl.close(SessionImpl.java:335)</span><br><span class="line">at org.springframework.orm.hibernate3.SessionFactoryUtils.closeSession(SessionFactoryUtils.java:802)</span><br><span class="line">at org.springframework.orm.hibernate3.SessionFactoryUtils.closeSessionOrRegisterDeferredClose(SessionFactoryUtils.java:788)</span><br><span class="line">at org.springframework.orm.hibernate3.HibernateTemplate.doExecute(HibernateTemplate.java:434)</span><br><span class="line">at org.springframework.orm.hibernate3.HibernateTemplate.executeWithNativeSession(HibernateTemplate.java:374)</span><br><span class="line">at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:512)</span><br><span class="line">at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:506)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/24/一次数据库连接泄露查找/" data-id="ck08ycust0009gofy1qudjgq3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-微信返回按钮触发关闭（android 和 iOS 都支持）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/17/微信返回按钮触发关闭（android 和 iOS 都支持）/" class="article-date">
  <time datetime="2018-09-17T03:02:38.000Z" itemprop="datePublished">2018-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="微信返回按钮触发关闭（android-和-iOS-都支持）"><a href="#微信返回按钮触发关闭（android-和-iOS-都支持）" class="headerlink" title="微信返回按钮触发关闭（android 和 iOS 都支持）"></a>微信返回按钮触发关闭（android 和 iOS 都支持）</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>微信认证需要跳转多层页面，这个这个时候如果用户点击返回的话就会在这个几个页面中循环跳来跳去的（比如登陆成功后，我们去到首页，这个时候用户用完后点击了返回。就又去掉了登陆页面去了），so，我们需要用户返回到登陆页面的时候就认为用需要关闭页面。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>进过多次试验得出结果如下<br>android 的页面放回每次都是刷新页面的，iOS 的返回是缓存的，不刷新页面。但是我们想要的效果是返回到指定页面的时候就触发关闭操作</p>
<p>一轮搜索，都是介绍使用监听 <code>popstate</code> 方法来实现，在 android 上的</p>
<p>2次就会回到指定链接</p>
<p>进入2此之后，就触发不了popstate事件了（经过测试，如果这个时候的返回页面就是你在 history.pushState 的页面地址，也就是说会重新载入这个页面，也就没有 popstate 什么事了）<br>history.pushState(null, null, “index4menu.jsp?xxxx”); 还会缓存</p>
<p>window.addEventListener(‘pageshow’, function () {<br>在点了2次以上的页面依旧会触发，但是却关闭不了页面</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>结合 <code>sessionStorage</code> 的特性（当前地址有页面打开的时候就存在，关闭就删除），我们使用一个变量存储在这个里面，一开始的时候就存储标记为，等到再次返回的时候触发到这个标记位后就关闭页面。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>先引入微信 js </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://res.wx.qq.com/open/js/jweixin-1.0.0.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> common = &#123;&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* （WeixinJSBridge）微信内置对象不是一开始就加载的，需要做回调，</span></span><br><span class="line"><span class="comment">*  jerry dai 20180917</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">common.wechatJSBridgeReady : <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> WeixinJSBridge == <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> WeixinJSBridge.invoke == <span class="string">"function"</span>) &#123;</span><br><span class="line">        callback();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">document</span>.addEventListener) &#123;</span><br><span class="line">            <span class="built_in">document</span>.addEventListener(<span class="string">"WeixinJSBridgeReady"</span>, callback, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.attachEvent) &#123;</span><br><span class="line">            <span class="built_in">document</span>.attachEvent(<span class="string">"WeixinJSBridgeReady"</span>, callback);</span><br><span class="line">            <span class="built_in">document</span>.attachEvent(<span class="string">"onWeixinJSBridgeReady"</span>, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 触发微信返回的时候关闭当前页面函数（主要用于登陆成功后跳转，在点击退回的时候发现停留在了跳转页面中）</span></span><br><span class="line"><span class="comment"> * @param key 缓存的 key（主要用于多个页面跳转的时候不冲突使用，不传递默认是isClose ）</span></span><br><span class="line"><span class="comment"> * @param fnOnSetFlagCallback 设置关闭标记的时候回调（主要用户控制页面的逻辑初始化）</span></span><br><span class="line"><span class="comment"> * @param fnCloseCallback 关闭的时候回调</span></span><br><span class="line"><span class="comment"> * jerry dai 20180917</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">common.goBackCloseWechatWindow : <span class="function"><span class="keyword">function</span> (<span class="params">key, fnOnSetFlagCallback, fnCloseCallback</span>) </span>&#123;</span><br><span class="line">	key = key || <span class="string">"isClose"</span>;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'pageshow'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> isClose = sessionStorage.getItem(key);</span><br><span class="line">        <span class="comment">// alert(key+":"+isClose+", "+window.location.href)</span></span><br><span class="line">        <span class="keyword">if</span>( isClose == <span class="string">"true"</span> )&#123;</span><br><span class="line">            (fnCloseCallback &amp;&amp; fnCloseCallback)();</span><br><span class="line">            common.wechatJSBridgeReady(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                WeixinJSBridge.call(<span class="string">'closeWindow'</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            sessionStorage.setItem(key, <span class="string">"true"</span>);</span><br><span class="line">			(fnOnSetFlagCallback &amp;&amp; fnOnSetFlagCallback)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://github.com/Tencent/weui/wiki/微信JSAPI" target="_blank" rel="noopener">https://github.com/Tencent/weui/wiki/微信JSAPI</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/17/微信返回按钮触发关闭（android 和 iOS 都支持）/" data-id="ck08ycusq0007gofytztgvn05" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-NISS 使用管理员运行" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/10/NISS 使用管理员运行/" class="article-date">
  <time datetime="2018-09-10T12:57:06.000Z" itemprop="datePublished">2018-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NISS-使用管理员运行"><a href="#NISS-使用管理员运行" class="headerlink" title="NISS 使用管理员运行"></a>NISS 使用管理员运行</h1><p>我需要执行一个命令，但是这个命令需要管理员权限才可以运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Name &quot;$&#123;PRODUCT_NAME&#125; $&#123;PRODUCT_VERSION&#125;&quot;</span><br><span class="line">OutFile &quot;xxxxx&quot;</span><br><span class="line">InstallDir &quot;xxxxx&quot;</span><br><span class="line">InstallDirRegKey HKLM &quot;$&#123;PRODUCT_UNINST_KEY&#125;&quot; &quot;UninstallString&quot;</span><br><span class="line">ShowInstDetails show</span><br><span class="line">ShowUnInstDetails show</span><br><span class="line">RequestExecutionLevel admin</span><br></pre></td></tr></table></figure>

<p>加入 RequestExecutionLevel admin 这句，在执行 mklink 的时候如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecWait &apos;cmd /c mklink /D &quot;D:\test02&quot; &quot;D:\test01&quot;&apos;</span><br></pre></td></tr></table></figure>

<p>注意：运行 <code>exe</code> 的时候需要右键使用管理员运行。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://nsis-dev.github.io/NSIS-Forums/html/t-314525.html" target="_blank" rel="noopener">https://nsis-dev.github.io/NSIS-Forums/html/t-314525.html</a><br><a href="http://www.it610.com/article/1835566.htm" target="_blank" rel="noopener">http://www.it610.com/article/1835566.htm</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/10/NISS 使用管理员运行/" data-id="ck08ycusz000cgofyvncdvcxj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-window软连接方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/10/window软连接方案/" class="article-date">
  <time datetime="2018-09-10T06:45:40.000Z" itemprop="datePublished">2018-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="window软连接方案"><a href="#window软连接方案" class="headerlink" title="window软连接方案"></a>window软连接方案</h1><p>如果你希望把一个目录在多个地方都可以访问。</p>
<blockquote>
<p>我这里说的访问是指比如：目标目录 d:\dir1，但是我希望使用 c:\dir1 来访问到这个目录。</p>
</blockquote>
<p>有人说，用一个快捷方式就 OK 啦，快捷方式只是作为跳转过去的，不能做到我说的这种效果。主要有的场景有，</p>
<ol>
<li>你的 C 盘爆了。但是相关的引用有需要在 C 盘，这个时候这个就可以做到。</li>
<li>开发程序的时候，你需要把固定目录挂载到 classpath 下面，（这种需求在 linux 下是很简单就可以做到），如果部署多机器集群的话，没有用文件服务器的话。共享应用之间的数据文件就会麻烦。（也可以使用文件同步来解决）。这个也可以做到。</li>
</ol>
<blockquote>
<p>我主要是解决第二个问题，我们的量还没有达到需要使用文件服务器。基本通过这种方式是可以解决当前问题了。</p>
</blockquote>
<h2 id="命令说明"><a href="#命令说明" class="headerlink" title="命令说明"></a>命令说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mklink /D &quot;link_name&quot; &quot;src_dir&quot;</span><br></pre></td></tr></table></figure>

<p>link_name 可以是一个具体的全路径的文件夹<br>src_dir 映射的目录</p>
<h2 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h2><p>可以使用 <code>Junction</code>，不过这个工具需要下载一个 exe，mklink是 window 自带的命令。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/sunzhenhua0608/article/details/9311241" target="_blank" rel="noopener">https://blog.csdn.net/sunzhenhua0608/article/details/9311241</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/10/window软连接方案/" data-id="ck08ycusf0002gofyy9502p7h" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-搭建ngrok服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/04/搭建ngrok服务/" class="article-date">
  <time datetime="2018-09-04T13:22:57.000Z" itemprop="datePublished">2018-09-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="搭建ngrok服务"><a href="#搭建ngrok服务" class="headerlink" title="搭建ngrok服务"></a>搭建ngrok服务</h1><p>ngrok 是什么，请看官网 <a href="http://ngrok.cn/" target="_blank" rel="noopener">http://ngrok.cn/</a>，简单来说就是一个可以把你的应用暴露到互联网中。</p>
<blockquote>
<p>开发过微信的童鞋都知道，微信一定要有域名和独占80端口的。然而调试的时候只能上到服务器上调试。所以你要练就一次编写，处处无 bug 的境界才可以。否则，你的代码会出现一堆的日志打印来调试。</p>
</blockquote>
<p>使用 ngrok 之后，你就可以在你本地调试开发了。因为这个使用的三级域名做转发。也就是说只要你的带宽顶得住。你是可以开无数个映射的。比如说：ngrok.xxxx.com 是你设置的二级域名。你希望下面的三级域名做转发。也就是说 a.ngrok.xxxx.com 可以映射一个应用，b.ngrok.xxxx.com 也可以映射另外的一个应用。</p>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><ul>
<li>首先你得有一个外网域名（备案过的）</li>
<li>此次你要有一个外网的虚拟主机（我的是帮瓦工最低配版本，$19/year，1核 512G内存 500G/月带宽）</li>
</ul>
<blockquote>
<p>如果你只有域名肿么办，还是有办法的。你可以低成本的去买一个别人已经搭好的 ngrok。比如 <a href="https://www.ngrok.cc/" target="_blank" rel="noopener">https://www.ngrok.cc/</a>，为什么说要有域名呢？业务他们家提供的域名已经被微信禁止使用了。<br>题外话：建议大家搞一个域名，因为你永远不知道一个小公司申请一个域名多麻烦。哈哈。</p>
</blockquote>
<h2 id="配置网络解析"><a href="#配置网络解析" class="headerlink" title="配置网络解析"></a>配置网络解析</h2><p>去到你的域名提供商。在解析中增加 A 类的映射。</p>
<ol>
<li>将 ngrok.xxxx.com 映射到你的外网服务器 ip 上。</li>
<li>*.ngrok.xxxx.com 同样映射到此外网 ip 上。</li>
</ol>
<h2 id="安装（Centos7）"><a href="#安装（Centos7）" class="headerlink" title="安装（Centos7）"></a>安装（Centos7）</h2><p>其实已经有大神们弄好了一键安装 <a href="https://github.com/sunnyos/ngrok" target="_blank" rel="noopener">https://github.com/sunnyos/ngrok</a>，步骤也超级简单。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.jianshu.com/p/b81bb6a3c0b9" target="_blank" rel="noopener">https://www.jianshu.com/p/b81bb6a3c0b9</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/04/搭建ngrok服务/" data-id="ck08ycuso0006gofy5p2nt8no" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-mysql通过分隔符匹配" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/08/mysql通过分隔符匹配/" class="article-date">
  <time datetime="2018-08-08T02:57:32.000Z" itemprop="datePublished">2018-08-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="mysql通过分隔符匹配"><a href="#mysql通过分隔符匹配" class="headerlink" title="mysql通过分隔符匹配"></a>mysql通过分隔符匹配</h1><p>存储的时候，一对多的时候，一个字段使用逗号分隔多个值，发现使用 INSTR 会出现问题，比如<br>admin1,admin2 这个时候如果使用 INSTR 来匹配是会匹配上的。这个时候就需要自定义函数来切割数据。因此就有了如下的函数（老夫已经多年没有写过 mysql 的函数了。如有 bug，那你来打我呀。）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 增加了函数判断方法</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">function</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`F_INSTR_FOR_SEPARATOR`</span>;</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> <span class="string">`F_INSTR_FOR_SEPARATOR`</span>(</span><br><span class="line">    userIds <span class="built_in">varchar</span>(<span class="number">256</span>),</span><br><span class="line">    matchUserId <span class="built_in">varchar</span>(<span class="number">256</span>),</span><br><span class="line">    _separator <span class="built_in">varchar</span>(<span class="number">10</span>)</span><br><span class="line">) <span class="keyword">RETURNS</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">CHARSET</span> utf8</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 待匹配的字符</span></span><br><span class="line">    <span class="keyword">declare</span> tempUserIds <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">default</span> userIds;</span><br><span class="line">    <span class="comment">-- 循环次数</span></span><br><span class="line">    <span class="keyword">declare</span> _count <span class="built_in">INTEGER</span>;</span><br><span class="line">    <span class="comment">-- 分隔出来的字符</span></span><br><span class="line">    <span class="keyword">declare</span> _tempUserId <span class="built_in">varchar</span>(<span class="number">256</span>);</span><br><span class="line">    <span class="comment">-- 是否匹配了</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">declare</span> _isMatch <span class="built_in">INTEGER</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">-- 定义分隔符好</span></span><br><span class="line">    <span class="keyword">declare</span> _tempSeparator <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">default</span> <span class="string">','</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 获取里面有多少个分隔符，用于循环</span></span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>+(<span class="keyword">length</span>(userIds) - <span class="keyword">length</span>(<span class="keyword">replace</span>(userIds,_tempSeparator,<span class="string">''</span>))) <span class="keyword">into</span> _count;</span><br><span class="line">    </span><br><span class="line">    WHILE _count &gt;= 0 DO</span><br><span class="line">    </span><br><span class="line">        <span class="comment">-- 找到第一个被分隔的字符进行匹配</span></span><br><span class="line">        <span class="keyword">SELECT</span> SUBSTRING_INDEX(tempUserIds, _tempSeparator, <span class="number">1</span>) <span class="keyword">into</span> _tempUserId;</span><br><span class="line">        </span><br><span class="line">        if matchUserId = _tempUserId then </span><br><span class="line">			<span class="keyword">set</span> _isMatch = <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">        <span class="comment">-- 去掉上面已经批评过的字符</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">SUBSTRING</span>(tempUserIds, <span class="keyword">INSTR</span>(tempUserIds,_tempSeparator)+<span class="number">1</span>) <span class="keyword">into</span> tempUserIds;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">set</span> _count = _count<span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">WHILE</span>;</span><br><span class="line">    </span><br><span class="line">RETURN _isMatch;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/08/mysql通过分隔符匹配/" data-id="ck08ycuss0008gofy8vpv85om" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-JavaScript 模块化编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/30/JavaScript 模块化编程/" class="article-date">
  <time datetime="2018-05-30T14:34:04.000Z" itemprop="datePublished">2018-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JavaScript-模块化编程"><a href="#JavaScript-模块化编程" class="headerlink" title="JavaScript 模块化编程"></a>JavaScript 模块化编程</h1><p>转载于 <a href="https://www.kancloud.cn/kancloud/javascript-standards-reference/46490" target="_blank" rel="noopener">https://www.kancloud.cn/kancloud/javascript-standards-reference/46490</a></p>
<p>随着网站逐渐变成”互联网应用程序”，嵌入网页的JavaiScript代码越来越庞大，越来越复杂。网页越来越像桌面程序，需要一个团队分工协作、进度管理、单元测试等等……开发者不得不使用软件工程的方法，管理网页的业务逻辑。</p>
<p>JavaScript模块化编程，已经成为一个迫切的需求。理想情况下，开发者只需要实现核心的业务逻辑，其他都可以加载别人已经写好的模块。</p>
<p>但是，JavaScript不是一种模块化编程语言，ES5不支持”类”（class），更遑论”模块”（module）了。ES6正式支持”类”和”模块”，但还没有成为主流。JavaScript社区做了很多努力，在现有的运行环境中，实现模块的效果。</p>
<h2 id="原始写法"><a href="#原始写法" class="headerlink" title="原始写法"></a>原始写法</h2><p>模块就是实现特定功能的一组方法。只要把不同的函数（以及记录状态的变量）简单地放在一起，就算是一个模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">m1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">m2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的函数 <code>m1()</code>和 <code>m2()</code>，组成一个模块。使用的时候，直接调用就行了。</p>
<p>这种做法的缺点很明显：”污染”了全局变量，无法保证不与其他模块发生变量名冲突，而且模块成员之间看不出直接关系。</p>
<h2 id="对象写法"><a href="#对象写法" class="headerlink" title="对象写法"></a>对象写法</h2><p>为了解决上面的缺点，可以把模块写成一个对象，所有的模块成员都放到这个对象里面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module1 = <span class="keyword">new</span> <span class="built_in">Object</span>(&#123;</span><br><span class="line">　_count : <span class="number">0</span>,</span><br><span class="line">　m1 : <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">　　<span class="comment">//...</span></span><br><span class="line">　&#125;,</span><br><span class="line">　m2 : <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  　<span class="comment">//...</span></span><br><span class="line">　&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的函数m1()和m2(），都封装在module1对象里。使用的时候，就是调用这个对象的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module1.m1();</span><br></pre></td></tr></table></figure>

<p>但是，这样的写法会暴露所有模块成员，内部状态可以被外部改写。比如，外部代码可以直接改变内部计数器的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module1._count = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h2 id="立即执行函数写法"><a href="#立即执行函数写法" class="headerlink" title="立即执行函数写法"></a>立即执行函数写法</h2><p>使用”立即执行函数”（Immediately-Invoked Function Expression，IIFE），可以达到不暴露私有成员的目的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module1 = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">　<span class="keyword">var</span> _count = <span class="number">0</span>;</span><br><span class="line">　<span class="keyword">var</span> m1 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">　  <span class="comment">//...</span></span><br><span class="line">　&#125;;</span><br><span class="line">　<span class="keyword">var</span> m2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">　　<span class="comment">//...</span></span><br><span class="line">　&#125;;</span><br><span class="line">　<span class="keyword">return</span> &#123;</span><br><span class="line">　　m1 : m1,</span><br><span class="line">　　m2 : m2</span><br><span class="line">　&#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>使用上面的写法，外部代码无法读取内部的_count变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.info(module1._count); <span class="comment">//undefined</span></span><br></pre></td></tr></table></figure>

<p>module1就是JavaScript模块的基本写法。下面，再对这种写法进行加工。</p>
<h2 id="放大模式"><a href="#放大模式" class="headerlink" title="放大模式"></a>放大模式</h2><p>如果一个模块很大，必须分成几个部分，或者一个模块需要继承另一个模块，这时就有必要采用”放大模式”（augmentation）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module1 = (<span class="function"><span class="keyword">function</span> (<span class="params">mod</span>)</span>&#123;</span><br><span class="line">　mod.m3 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">　　<span class="comment">//...</span></span><br><span class="line">　&#125;;</span><br><span class="line">　<span class="keyword">return</span> mod;</span><br><span class="line">&#125;)(module1);</span><br></pre></td></tr></table></figure>

<p>上面的代码为module1模块添加了一个新方法m3()，然后返回新的module1模块。</p>
<h2 id="宽放大模式（Loose-augmentation）"><a href="#宽放大模式（Loose-augmentation）" class="headerlink" title="宽放大模式（Loose augmentation）"></a>宽放大模式（Loose augmentation）</h2><p>在浏览器环境中，模块的各个部分通常都是从网上获取的，有时无法知道哪个部分会先加载。如果采用上一节的写法，第一个执行的部分有可能加载一个不存在空对象，这时就要采用”宽放大模式”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module1 = ( <span class="function"><span class="keyword">function</span> (<span class="params">mod</span>)</span>&#123;</span><br><span class="line">　<span class="comment">//...</span></span><br><span class="line">　<span class="keyword">return</span> mod;</span><br><span class="line">&#125;)(<span class="built_in">window</span>.module1 || &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>与”放大模式”相比，＂宽放大模式＂就是”立即执行函数”的参数可以是空对象。</p>
<h2 id="输入全局变量"><a href="#输入全局变量" class="headerlink" title="输入全局变量"></a>输入全局变量</h2><p>独立性是模块的重要特点，模块内部最好不与程序的其他部分直接交互。</p>
<p>为了在模块内部调用全局变量，必须显式地将其他变量输入模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> module1 = (<span class="function"><span class="keyword">function</span> (<span class="params">$, YAHOO</span>) </span>&#123;</span><br><span class="line">　<span class="comment">//...</span></span><br><span class="line">&#125;)(jQuery, YAHOO);</span><br></pre></td></tr></table></figure>

<p>上面的module1模块需要使用jQuery库和YUI库，就把这两个库（其实是两个模块）当作参数输入module1。这样做除了保证模块的独立性，还使得模块之间的依赖关系变得明显。</p>
<h2 id="使用构造函数封装私有变量"><a href="#使用构造函数封装私有变量" class="headerlink" title="使用构造函数封装私有变量"></a>使用构造函数封装私有变量</h2><p>可以利用构造函数，封装私有变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StringBuilder</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> buffer = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.add = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">        buffer.push(str);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buffer.join(<span class="string">''</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方法将私有变量封装在构造函数中，违反了构造函数与实例对象相分离的原则。并且，非常耗费内存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StringBuilder</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._buffer = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">StringBuilder.prototype = &#123;</span><br><span class="line">    <span class="keyword">constructor</span>: StringBuilder,</span><br><span class="line">    add: function (str) &#123;</span><br><span class="line">        <span class="keyword">this</span>._buffer.push(str);</span><br><span class="line">    &#125;,</span><br><span class="line">    toString: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._buffer.join(<span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这种方法将私有变量放入实例对象中，好处是看上去更自然，但是它的私有变量可以从外部读写，不是很安全。</p>
<h2 id="IIFE封装私有变量"><a href="#IIFE封装私有变量" class="headerlink" title="IIFE封装私有变量"></a>IIFE封装私有变量</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;  <span class="comment">// open IIFE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// public</span></span><br><span class="line">    <span class="keyword">var</span> self = &#123;</span><br><span class="line">        publicMethod: <span class="function"><span class="keyword">function</span> (<span class="params">...</span>) </span>&#123;</span><br><span class="line">            privateData = ...;</span><br><span class="line">            privateFunction(...);</span><br><span class="line">        &#125;,</span><br><span class="line">        publicData: ...</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private</span></span><br><span class="line">    <span class="keyword">var</span> privateData = ...;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params">...</span>) </span>&#123;</span><br><span class="line">        privateData = ...;</span><br><span class="line">        self.publicData = ...;</span><br><span class="line">        self.publicMethod(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;(); <span class="comment">// close IIFE</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://jerryzou.com/posts/jsmodular/" target="_blank" rel="noopener">http://jerryzou.com/posts/jsmodular/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/30/JavaScript 模块化编程/" data-id="ck08ycuv2000hgofyptma7i7p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-jQuery插件开发-面向对象" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/29/jQuery插件开发-面向对象/" class="article-date">
  <time datetime="2018-05-29T12:49:46.000Z" itemprop="datePublished">2018-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="jQuery插件开发-面向对象"><a href="#jQuery插件开发-面向对象" class="headerlink" title="jQuery插件开发-面向对象"></a>jQuery插件开发-面向对象</h1><p>最近在做一个 OA 项目，需要重写整个前端页面。一开始整个工作并非是我牵头主导开发，缺少思考。导致后面扩展、开发困难。以至于牵一发动全身。总结一下经验。让童鞋开发的时候好注意一下。（因为这个锅现在是我背，我需要优化。。。）</p>
<p>我们如果做面向对象开发的时候，我们知道，一切皆对象。内部的封装细节我们都不需要知道，我们只要知道外部调用逻辑即可。基于这种思想我们也可以套用到前端的 JavaScript 中去。用过很多前端控件的童鞋都知道，在使用这些控件的时候提供很多切面方法给我们回调使用来实现定制需求。以下介绍也是围绕着此处展开。</p>
<h2 id="插件实现想法"><a href="#插件实现想法" class="headerlink" title="插件实现想法"></a>插件实现想法</h2><p>提供丰富的切面方法，如果是一个树形控件对象封装，基本要提供获一下方法</p>
<ul>
<li>获取数据源回调方法（用于构建树形结构数据）</li>
<li>实例创建成功方法回调</li>
<li>点击选择事件回调</li>
<li>多选选中事件回调</li>
</ul>
<p>。。。等。</p>
<p>以上只是列举了部分业务场景需要用的方法。详细需要自行结合业务需求。</p>
<p>这样的话使用此控件人只需要组合这些切面方法就可以使用该有的功能。其他细节不需要处理。按照功能性的不同提供差异化的接口处理方式。但是更加建议在一套系统中插件提供的切面处理是一致的（因为业务千变万化，实际操作中可能做不到。）</p>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><h3 id="常用实现方式"><a href="#常用实现方式" class="headerlink" title="常用实现方式"></a>常用实现方式</h3><p>最常用的方法是在对象实例化的时候把相关切面方法带入到指定的参数中去，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#test'</span>).tree(&#123;</span><br><span class="line">    on: &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 点击事件触发的回调方法（单选是点击节点触发，多选是勾选时触发）</span></span><br><span class="line"><span class="comment">         * @param self 当前对象</span></span><br><span class="line"><span class="comment">         * @param treeNode 点击的节点</span></span><br><span class="line"><span class="comment">         * @param clickItemObj 选中的对象信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        onClickItem: <span class="function"><span class="keyword">function</span> (<span class="params">self, treeNode, clickItemObj</span>) </span>&#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取构建 ztree 的数据，数据结构和 ztree 要求的格式一致</span></span><br><span class="line"><span class="comment">         * @param callback 构建好的数据回调（必须）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        onGetTreeData: <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">            callback();</span><br><span class="line">        &#125;,</span><br><span class="line">        onHide : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">        onChange : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">        onInitAfter : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这种更多是用于和此对象非常结合很紧密的场景。需要拿到对象的实例化权利才可以做到。</p>
<h3 id="基于-jQuery-data-对象注册方式"><a href="#基于-jQuery-data-对象注册方式" class="headerlink" title="基于 jQuery data 对象注册方式"></a>基于 jQuery data 对象注册方式</h3><p>适用场景：你无法掌控对象的创建（也就是没办法在初始化的时候就载入切面回调方法）。或者说你无法提供在初始化的时候个性化切面方法的需求就可以采用这个方式了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#test'</span>).data(<span class="string">'callback'</span>, &#123;</span><br><span class="line">    on: &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 点击事件触发的回调方法（单选是点击节点触发，多选是勾选时触发）</span></span><br><span class="line"><span class="comment">         * @param self 当前对象</span></span><br><span class="line"><span class="comment">         * @param treeNode 点击的节点</span></span><br><span class="line"><span class="comment">         * @param clickItemObj 选中的对象信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        onClickItem: <span class="function"><span class="keyword">function</span> (<span class="params">self, treeNode, clickItemObj</span>) </span>&#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取构建 ztree 的数据，数据结构和 ztree 要求的格式一致</span></span><br><span class="line"><span class="comment">         * @param callback 构建好的数据回调（必须）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        onGetTreeData: <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">            callback();</span><br><span class="line">        &#125;,</span><br><span class="line">        onHide : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">        onChange : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">        onInitAfter : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里留有缺陷，就如果一个对象被多次调用以上方法的话。只会保留最后一个对象。（这里可以改动先判断是否有对象，有对象就变成一个 list，代码我懒得改了 -_-）。</p>
<p>在使用此方法注册切面方法的时候需要在编写插件的时候去获取 <code>data</code> 对象里面的方法进行回调</p>
<p>以上只是提供一种思路，具体还有很多实现方式的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>jQuery data 对象介绍 <a href="https://api.jquery.com/data/" target="_blank" rel="noopener">https://api.jquery.com/data/</a><br>jQuery 插件编写 <a href="https://www.kancloud.cn/kancloud/javascript-standards-reference/46484" target="_blank" rel="noopener">https://www.kancloud.cn/kancloud/javascript-standards-reference/46484</a><br>JavaScript 模块化编程 <a href="https://www.kancloud.cn/kancloud/javascript-standards-reference/46490" target="_blank" rel="noopener">https://www.kancloud.cn/kancloud/javascript-standards-reference/46490</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/29/jQuery插件开发-面向对象/" data-id="ck08ycv6o000igofy1bsqr58o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ie9 在打开控制台可以正常加载页面，否则加载失败" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/28/ie9 在打开控制台可以正常加载页面，否则加载失败/" class="article-date">
  <time datetime="2018-05-28T06:18:58.000Z" itemprop="datePublished">2018-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ie9-在打开控制台可以正常加载页面，否则加载失败"><a href="#ie9-在打开控制台可以正常加载页面，否则加载失败" class="headerlink" title="ie9 在打开控制台可以正常加载页面，否则加载失败"></a>ie9 在打开控制台可以正常加载页面，否则加载失败</h1><p>最近在调试个 bug，不开启控制台的话死活页面加载不出来。开启了控制台后页面就显示正常。<br>经过一顿搜索，得知在 ie9 下，如果不开启控制台的话，默认是没有 console 对象的，开启后则有。</p>
<p>汇总网上的解决方案，改造如下。新增 console.js，内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">11</span>)</span><br><span class="line">&#125;<span class="keyword">catch</span> (e)&#123;</span><br><span class="line">    ;(<span class="function"><span class="keyword">function</span>(<span class="params">g</span>) </span>&#123;</span><br><span class="line"><span class="meta">        'use strict'</span>;</span><br><span class="line">        <span class="keyword">var</span> _console = g.console || &#123;&#125;;</span><br><span class="line">        <span class="keyword">var</span> methods = [<span class="string">'assert'</span>, <span class="string">'clear'</span>, <span class="string">'count'</span>, <span class="string">'debug'</span>, <span class="string">'dir'</span>, <span class="string">'dirxml'</span>, <span class="string">'exception'</span>, <span class="string">'error'</span>, <span class="string">'group'</span>, <span class="string">'groupCollapsed'</span>, <span class="string">'groupEnd'</span>, <span class="string">'info'</span>, <span class="string">'log'</span>, <span class="string">'profile'</span>, <span class="string">'profileEnd'</span>, <span class="string">'table'</span>, <span class="string">'time'</span>, <span class="string">'timeEnd'</span>, <span class="string">'timeStamp'</span>, <span class="string">'trace'</span>, <span class="string">'warn'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">console</span> = &#123;<span class="attr">version</span>: <span class="string">'0.1.0'</span>&#125;;</span><br><span class="line">        <span class="keyword">var</span> key;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = methods.length; i &lt; len; i++) &#123;</span><br><span class="line">            key = methods[i];</span><br><span class="line">            <span class="built_in">console</span>[key] = <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> _console[key] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">Function</span>.prototype.apply.call(_console[key], _console, <span class="built_in">arguments</span>);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        g.console = <span class="built_in">console</span>;</span><br><span class="line">    &#125;(<span class="built_in">window</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在具体页面引用的时候使用只有 ie9 才能识别的脚本</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--[if IE 9]&gt;</span></span><br><span class="line"><span class="comment">	&lt;script src="console.js" type="text/javascript"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="comment">&lt;![endif]--&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://yanhaijing.com/javascript/2014/11/03/use-console.js/" target="_blank" rel="noopener">https://yanhaijing.com/javascript/2014/11/03/use-console.js/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/28/ie9 在打开控制台可以正常加载页面，否则加载失败/" data-id="ck08ycut7000ggofyzfr1rx4l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-struts2.3升级到 struts2.5.13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/21/struts2.3升级到 struts2.5.13/" class="article-date">
  <time datetime="2017-11-21T13:47:58.000Z" itemprop="datePublished">2017-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="struts2-3升级到-struts2-5-13"><a href="#struts2-3升级到-struts2-5-13" class="headerlink" title="struts2.3升级到 struts2.5.13"></a>struts2.3升级到 struts2.5.13</h1><h1 id="1-log4j-1-升级到-log4j-2"><a href="#1-log4j-1-升级到-log4j-2" class="headerlink" title="1. log4j 1 升级到 log4j 2"></a>1. log4j 1 升级到 log4j 2</h1><p>1、删除掉 log4j 1的配置文件。如 classpath 下面的 log4j.xml 或者 log4j.properties。<br>2、新增 log4j2.xml 文件在 classpath 下。以下是最基本的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- all 为所有的都输出 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"all"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我的生产配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFileInfo"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/info.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/$$&#123;date:yyyy-MM&#125;/info-%d&#123;yyyy-MM-dd&#125;-%i.log"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--设置只输出级别为INFO的日志--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"INFO"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"WARN"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"ERROR"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"20MB"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFileWarn"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/warn.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/$$&#123;date:yyyy-MM&#125;/warn-%d&#123;yyyy-MM-dd&#125;-%i.log"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--设置只输出级别为WARN的日志--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"WARN"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"ERROR"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"20MB"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"RollingFileError"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/error.log"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">"$&#123;sys:catalina.home&#125;/logs/web/$$&#123;date:yyyy-MM&#125;/error-%d&#123;yyyy-MM-dd&#125;-%i.log"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--设置只输出级别为ERROR的日志--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"ERROR"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d %-5p [%t] %C&#123;2&#125; (%F:%L) - %m%n"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"20MB"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;logger name="org.springframework" level="INFO"/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;logger name="org.hibernate" level="INFO"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"RollingFileInfo"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"RollingFileWarn"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"RollingFileError"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、maven 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-去除xerces依赖"><a href="#2-去除xerces依赖" class="headerlink" title="2. 去除xerces依赖"></a>2. 去除xerces依赖</h1><p>1、 移除对 xerces 的依赖包括 xerces、xercesImpl、mlParserAPIs（重点）<br>2、 maven 移除以下配置（检查 lib 中是否已经移除掉了）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xerces<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xerces<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xercesImpl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>maven 工程，需要分析依赖（使用命令 <code>mvn dependency:tree</code> ）是否存在传递的依赖的xerces<br><a href="http://chwshuang.iteye.com/blog/2069937" target="_blank" rel="noopener">阻止依赖传送门</a><br>注意：如果依赖的 jar 文件中还存在以上的 jar 会出现一个错误是说注解无法注入。据说是 JDK 默认携带了此类的实现。</p>
<blockquote>
<p>小插曲：出现下面的问题的时候，真心奔溃。这个提示明显是说annotation转换出现异常。看了2.5.13的源码。<code>org.apache.struts2.convention.annotation.Result.name()</code>这个是一个数组，而在2.3里面确实一个<code>string</code>，各种排查。无果。重新<code>build</code>了工程，也就是去掉了<code>xerces</code>这些依赖</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.annotation.AnnotationTypeMismatchException: Incorrectly typed data found for annotation element public abstract java.lang.String[] org.apache.struts2.convention.annotation.Result.name() (Found data of type class java.lang.String[view])</span><br></pre></td></tr></table></figure>

<h1 id="3-Struts2-配置文件修改"><a href="#3-Struts2-配置文件修改" class="headerlink" title="3. Struts2 配置文件修改"></a>3. Struts2 配置文件修改</h1><p>struts2 的配置文件修改 dtd 头部引用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE struts PUBLIC</span></span><br><span class="line"><span class="meta">	"-//Apache Software Foundation//DTD Struts Configuration 2.5//EN"</span></span><br><span class="line"><span class="meta">	"http://struts.apache.org/dtds/struts-2.5.dtd"&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="4-遗留问题"><a href="#4-遗留问题" class="headerlink" title="4. 遗留问题"></a>4. 遗留问题</h1><p>如果系统中使用 struts <code>struts.convention.action.includeJars</code>来导入包的话（配置如下）。会在tomcat6和7偶然出现在 classpath 找不到指定的 jar 文件。但是在最新版的 tomcat 8.5.23 是可以的。但是最奇怪的是 <code>build</code> 多几次就可以了 <del>_</del></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">"struts.convention.action.includeJars"</span> <span class="attr">value</span>=<span class="string">".*?/includeFile.*?jar(!/)?"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>后面要研究一下这个扫包的逻辑</strong></p>
<h1 id="4-1-更新20171126"><a href="#4-1-更新20171126" class="headerlink" title="4.1 更新20171126"></a>4.1 更新20171126</h1><p>经过发现 <code>struts.convention.action.includeJars</code> 的 <code>jar</code> 文件没有<code>META-INF</code>文件夹。正确的jar 文件目录是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*.jar</span><br><span class="line">|--META-INF</span><br><span class="line">|--com</span><br><span class="line">    |--youpackage</span><br></pre></td></tr></table></figure>

<p>而在 lib 下面的却没有 <code>META-INF</code>。<br>使用 命令<code>mvn clean install</code> 打包的时候看了输出的目录的 <code>jar</code> 所有东西都有。然后在本地的 <code>repositories</code> 里面的 jar 也没有问题。</p>
<p><img src="http://img.lsof.fun/2019-01-28-15486498815104.jpg" alt="-c"><br>后来发现原来是这个锅是 <code>IDEA</code> 的。系统分为4个工程。依赖如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">d工程（web）</span><br><span class="line">|--src</span><br><span class="line">|--WebRoot</span><br><span class="line">    |--WEB-INF</span><br><span class="line">        |--lib</span><br><span class="line">            |--a工程.jar</span><br><span class="line">            |--b工程.jar</span><br><span class="line">            |--c工程.jar</span><br><span class="line">        |--classes</span><br></pre></td></tr></table></figure>

<p>如果在 <code>IDEA</code> 中导入 d工程。然后再导入 其他三个工程。启动 tomcat 的时候 IDEA 会自动编译一下其他的三个工程。把其他三个工程的 <code>jar</code> 文件打包到 <code>lib</code> 下面。打包的时候就出现没有 <code>jar</code> 文件 <code>META-INF</code>这个目录。最奇怪的第二次启动就可以了<del>_</del>。</p>
<h1 id="5-备注"><a href="#5-备注" class="headerlink" title="5. 备注"></a>5. 备注</h1><ol>
<li>实验过 <code>jar</code> 文件中必须有<code>META-INF</code>这层目录（里面可以没有描述文件）。没有的话跳过此包不扫描。<em>（猜想：估计在 tomcat6、7 扫描的时候没有此目录的话可能会被认为是普通的压缩文件。不需要装载到系统中去。tomcat8是支持没有<code>META-INF</code>的）</em> 。有兴趣的可以去官网看卡 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jar/jar.html" target="_blank" rel="noopener">传送门</a>。另外发现IBM 一篇干货 <a href="https://www.ibm.com/developerworks/cn/java/j-jar/index.html" target="_blank" rel="noopener">link</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/21/struts2.3升级到 struts2.5.13/" data-id="ck08ycusy000bgofy5oj7ru3w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/09/07/test/">test</a>
          </li>
        
          <li>
            <a href="/2019/09/05/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2019/07/07/我的博客搬家啦/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/07/07/记上车时间-2019年6月29日早上7点/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/07/06/mysql 5.6.38 安装（redhat 6）/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>